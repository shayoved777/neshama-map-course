#############################################
# streamlit_app.py
#############################################

import streamlit as st
import random
from datetime import datetime
from pyluach import dates

#############################################
# הגדרת עמוד + עיצוב בסיסי
#############################################

st.set_page_config(
    page_title="מפת הנשמה - גרסה מורחבת",
    page_icon="✨",
    layout="centered",
)

page_style = """
<style>
body {
    background: linear-gradient(to bottom right, #0a0f59, #d9b566);
    color: #ffffff;
    font-family: "David", sans-serif;
    text-align: right;
    direction: rtl;
}
h1, h2, h3 {
    color: #ffd700;
}
div.stButton>button {
  background-color: #b8993c !important;
  color: #0b0b0b !important;
  border-radius: 10px !important;
  font-size: 1.1rem !important;
  font-weight: bold !important;
  border: none !important;
  padding: 0.6em 1em !important;
  cursor: pointer;
}
div.stButton>button:hover {
  background-color: #8f772e !important;
}
</style>
"""
st.markdown(page_style, unsafe_allow_html=True)

#############################################
# מילון הנתונים המורחב לכל 12 המזלות
#############################################

zodiac_data = {
    "טלה": {
        "intro": (
            "מזל טלה מייצג פריצה, התחדשות וכוח ראשיתי. "
            "נולדי טלה נחשבים לאלה שמביאים רוח חדשה במה שהם עושים, "
            "אך זקוקים ללמוד מידה של סבלנות."
        ),
        "pasuk": "“ה' אלוקי אבותיכם יֹסף עֲליכם כָּכֶם אֶלֶף פְּעָמִים” (דברים א', י”א)",
        "zohar": (
            "בזוהר נאמר שרוח ראשית זו יכולה להצית בריאה חדשה בעולם, "
            "אם האדם מכוון את התלהבותו לשם שמיים."
        ),
        "arizal": (
            "האר״י מלמד שכוח האש שבטלה יוצר 'התעוררות גדולה', אך יש לרסנו כדי "
            "שלא יהפוך לאגו בוער."
        ),
        "tanya": (
            "בתניא (למשל פרק ל') מודגש שבעלי התלהבות ראשונית נדרשים להכניס חום זה "
            "לעבודת ה' ומצוות."
        ),
        "summary": "טלה מסמל התחדשות ואומץ. התיקון: לעדן את הכוח ולהשתמש בו לבנייה רוחנית."
    },

    "שור": {
        "intro": (
            "מזל שור מביא איתו יציבות, התמדה וכוח אדיר המופנה לעבודה שקדנית. "
            "יש בו נטייה לאהבת החומר בצורה חיובית – לבנות ולהפרות."
        ),
        "pasuk": "“בכור שורו הדר לו” (דברים ל”ג, י”ז)",
        "zohar": (
            "הזוהר מדבר על עקשנות קדושה שבונה תשתית למציאות מתוקנת. "
            "השור 'חורש' ומצמיח יבול רוחני וחומרי."
        ),
        "arizal": (
            "האר״י מציין ששור מעלה ניצוצות קדושה מתוך העמל והארציות, "
            "וכך מברר את העולם בגשמיותו."
        ),
        "tanya": (
            "בתניא מודגש שכוח התמדה ועשייה עקבית משנה את ליבו של האדם לאורך זמן, "
            "כמו חרישה בעומק הנפש."
        ),
        "summary": "שור מסמל עוצמה סבלנית, בנייה איטית ויציבה. התיקון: להימנע מנטייה לעקשנות שלילית."
    },

    "תאומים": {
        "intro": (
            "מזל תאומים מייצג תנועה, תקשורת וגמישות. "
            "היכולת לחבר בין ניגודים בצורה קלילה ומציאת גשרים בין אנשים ורעיונות."
        ),
        "pasuk": "“וַיֵּצֵא הָרִאשׁוֹן... וְאַחֲרֵי כֵן יָצָא אָחִיו” (בראשית כ״ה, כ”ה–כ”ו)",
        "zohar": (
            "הזוהר רומז על 'זוגיות' בכוחות הנפש, חיבור חסד וגבורה בנפש אחת, "
            "המזכיר טבע של תאומים."
        ),
        "arizal": (
            "בכתבי האר״י: האדם בעל שתי בחינות — יצר טוב ויצר רע — והאתגר הוא "
            "לאחד אותם בעבודת הבורא."
        ),
        "tanya": (
            "התניא מסביר (פרקים י”ב–י”ג) שקיימת מלחמה פנימית בין נפש בהמית לנפש אלוקית, "
            "והאדם לומד לנהל דיאלוג ביניהן."
        ),
        "summary": "תאומים: סמל לריבוי כוחות, תקשורת ויצירתיות. תיקון: ללמוד למקד כוחות ולא להתפזר."
    },

    "סרטן": {
        "intro": (
            "מזל סרטן מדגיש רגישות, אינטואיציה ועומק רגשי, עם צורך בביטחון ובסיס ביתי. "
            "בעל יכולת לטפח ולהזין את הסביבה."
        ),
        "pasuk": "“עֵץ חַיִּים הִיא לַמַּחֲזִיקִים בָּהּ” (משלי ג', י”ח)",
        "zohar": (
            "הזוהר מזהה את הדימוי 'מים' כאנרגיית חיים רגשית הזורמת ומחייה. "
            "סרטן מזוהה עם יסוד המים המזין."
        ),
        "arizal": (
            "האר״י מלמד שתנועת הרגש, אם מכוונת בקדושה, מעלה את האדם. "
            "אך יש להיזהר מצער או פסימיות."
        ),
        "tanya": (
            "בתניא (פרק ל”ב) מודגש שהרגש יכול להוביל לאהבת ישראל ולחסד רב, "
            "בלבד שלא נופלים לרגשנות שלילית."
        ),
        "summary": "סרטן: אהבה ביתית וחמלה. תיקון: להקפיד על ביטוי רגשי מאוזן ולא להסתגר מפחד."
    },

    "אריה": {
        "intro": (
            "מזל אריה מדגיש כריזמה, אומץ ונוכחות בולטת. "
            "מביא עימו הנהגה טבעית ונדיבות, לצד סכנת גאווה."
        ),
        "pasuk": "“גּוּר אַרְיֵה יְהוּדָה” (בראשית מ”ט, ט’)",
        "zohar": (
            "הזוהר מכנה את הכוח המלכותי 'לבאריה' — לב אמיץ המקרין על הסביבה."
        ),
        "arizal": (
            "בכתבי האר״י נרמז כי 'אש המלכות' דורשת ענווה גדולה, "
            "שאחרת הופכת לגאווה מזיקה."
        ),
        "tanya": (
            "בתניא, אדם בעל ביטחון עצמי יכול לרומם אחרים בתורה ומצוות, "
            "באם זוכר שמקור הכוח הוא אלוקי."
        ),
        "summary": "אריה: מנהיגות, כריזמה וחום לב. תיקון: לשמור על ענווה ומתן כבוד לאחרים."
    },

    "בתולה": {
        "intro": (
            "מזל בתולה מסמל דיוק, אנליטיות ושירותיות. בעל כישרון לרדת לפרטים, "
            "אך לפעמים נוטה לביקורתיות."
        ),
        "pasuk": "“סֻלַּת חִטִּים תֵּאפוּ” (ויקרא כ”ג)",
        "zohar": (
            "בזוהר מוזכר שליטה בפרטים קטנים כמפתח להשגת תיקון כללי: "
            "‘כמלאכים שמזהירים על הפרטים’."
        ),
        "arizal": (
            "האר״י מצביע על 'בירור ניצוצות' — לאסוף את הקדושה מתוך הפרטים "
            "ולחברם לתמונה שלמה."
        ),
        "tanya": (
            "בתניא מודגש שתהליך איטי של אתכפיא (כפיית היצר) דורש תשומת לב לפרטים "
            "במעשים היומיומיים."
        ),
        "summary": "בתולה: דיוק ושאיפה לסדר. תיקון: לאזן בין ביקורת לבין חמלה ולשמוח בתהליכי תיקון."
    },

    "מאזניים": {
        "intro": (
            "מזל מאזניים עוסק באיזון, הרמוניה וצדק. בעלי יכולת לראות שני צדדים, "
            "אך עלולים להסס מהכרעה."
        ),
        "pasuk": "“דַּן יָדִין עַמּוֹ” (בראשית מ”ט, ט”ז) — רמז לכוח הדין והאיזון.",
        "zohar": (
            "הזוהר: המאזניים הם סמל למידת הדין והרחמים המתרסנים זה את זה, "
            "וכך נוצרת שלמות."
        ),
        "arizal": (
            "בכתבי האר״י: צריך לשמור על 'קו האמצע' כדי לעלות במדרגות הקדושה."
        ),
        "tanya": (
            "התניא (פ”י-י”א) דן בצורך לשפוט את עצמך ביושר ולא להתייאש, "
            "מצד שני לא להקל ראש ולהישאר באזור הנוחות."
        ),
        "summary": "מאזניים: הרמוניה ושאיפה לצדק. תיקון: החלטיות ולא להיתקע בין לבטים."
    },

    "עקרב": {
        "intro": (
            "מזל עקרב מייצג עומק רגשי, מסתורין ועוצמה פנימית. "
            "עלול לנוע בין קיצוניות של אור וחושך."
        ),
        "pasuk": "“מַיִם עֲמֻקִּים עֵצָה בְלֶב־אִישׁ” (משלי כ’, ה’)",
        "zohar": (
            "הזוהר: כוח לרדת לשורשי החושך ולעלות משם ניצוצות, אך ביד האדם "
            "להיזהר מכעס ונקמה."
        ),
        "arizal": (
            "האר״י: 'ירידה לצורך עלייה' היא המוטו לעוסקים בתיקון עולם, "
            "בוודאי לבעלי נשמה חזקה."
        ),
        "tanya": (
            "בתניא, רגשות עזים יכולים להפוך לקנאה חיובית בקדושה, "
            "כשמנתביםם לעבודת ה'."
        ),
        "summary": "עקרב: עומק ותשוקה. תיקון: להשתמש ברגש העז כדי להאיר, לא להרוס."
    },

    "קשת": {
        "intro": (
            "מזל קשת מסמל אהבת חופש, אופטימיות ותנועה מתמדת להרפתקאות וחתירה לאופקים חדשים."
        ),
        "pasuk": "“וְלִבְנֵי יְהוּדָה קֶשֶׁת לָמְּדוּ” (שמואל ב’ א’, י”ח)",
        "zohar": (
            "הזוהר משווה את הקשת ליכולת לפגוע למרחוק — חזון ושאיפה רוחנית גבוהה."
        ),
        "arizal": (
            "בכתבי האר״י: אנרגיית הפריצה צריכה תיעול וכוונה, "
            "אחרת נשארת התלהבות חולפת."
        ),
        "tanya": (
            "התניא מעודד להפוך את שמחת הקשת לשמחה פנימית באמונה, "
            "ולא רק להסתפק בתאוות העולם."
        ),
        "summary": "קשת: הרפתקה ואמונה. תיקון: להציב מטרה נעלה ולא לזלוג לאי־מחויבות."
    },

    "גדי": {
        "intro": (
            "מזל גדי רומז על אחריות, שאפתנות ואופי רציני. "
            "בעלי גישה מעשית והדרגתית להגשמת מטרות."
        ),
        "pasuk": "“מִי־יָעֲלֶה בְהַר ה'... נְקִי כַפַּיִם” (תהילים כ”ד, ג’-ד’)",
        "zohar": (
            "הזוהר מלמד שעלייה איטית אך בטוחה כמוה כסולם מוצב — מרמז לחוסן הגדי "
            "בהרים תלולים."
        ),
        "arizal": (
            "האר״י רומז שכוח ה'מלכות' בגדי מתבטא בבנייה לטווח ארוך בעולם הגשמי."
        ),
        "tanya": (
            "התניא מבהיר שעבודה מתמדת וימיומית לבסוף שוברת את היצר העיקש, "
            "כמו טיפת מים המחוררת אבן."
        ),
        "summary": "גדי: חתירה רצינית ויציבה. תיקון: איזון בין עבודה קשה לרכות גמישה."
    },

    "דלי": {
        "intro": (
            "מזל דלי מסמל חשיבה מחוץ לקופסה, חדשנות ורצון עמוק לשינוי. "
            "בעל ראייה עתידית וחיפוש אחר חופש."
        ),
        "pasuk": "“וַיִּבֶן עִיר חֲדָשָׁה” (רמז לצורת בנייה חדשה)",
        "zohar": (
            "הזוהר: זרימת מים עליונה מרמזת על שפע חכמה ורעיונות חדשניים."
        ),
        "arizal": (
            "בכתבי האר״י: יש לאזן את פריצת הגבולות שלא תפגע בסדר האלוקי."
        ),
        "tanya": (
            "התניא מעודד להשתמש בשכל ובהבנה רוחנית כדי ליצור שינוי אמיתי."
        ),
        "summary": "דלי: מקוריות ושאיפה לשפר את העולם. תיקון: לא להרוס הכול אלא לחדש בחוכמה."
    },

    "דגים": {
        "intro": (
            "מזל דגים מציין רגש עמוק, חלומות ורוחניות נסתרת. "
            "בעלי רגישות גבוהה לזולת."
        ),
        "pasuk": "“וְיִדְגּוּ לָרֹב בְּקֶרֶב הָאָרֶץ” (בראשית מ”ח, ט”ז)",
        "zohar": (
            "הזוהר מדמה את הדגים לפנימיות הנסתרת, שחיה 'תחת פני המים'."
        ),
        "arizal": (
            "האר״י מציין שנפשות עדינות נוטות להיות זקוקות למסגרת ברורה "
            "כדי לא להישאב לרגש שלילי."
        ),
        "tanya": (
            "התניא מדגיש את חשיבות החמלה והחיבור ללב, יחד עם עבודה שכלית, "
            "כדי לא לטבוע בעולם הדמיון."
        ),
        "summary": "דגים: רגש עמוק וחיבור פנימי. תיקון: להציב גבולות ולא לברוח מהמציאות."
    }
}

#############################################
# פונקציית גימטריה
#############################################

def gematria(text: str) -> int:
    letter_values = {
        'א': 1, 'ב': 2, 'ג': 3, 'ד': 4, 'ה': 5, 'ו': 6, 'ז': 7, 'ח': 8, 'ט': 9,
        'י': 10, 'כ': 20, 'ך': 20, 'ל': 30, 'מ': 40, 'ם': 40, 'נ': 50, 'ן': 50,
        'ס': 60, 'ע': 70, 'פ': 80, 'ף': 80, 'צ': 90, 'ץ': 90, 'ק': 100, 'ר': 200,
        'ש': 300, 'ת': 400
    }
    total = 0
    for char in text:
        if char in letter_values:
            total += letter_values[char]
    return total


#############################################
# קביעת שם המזל לפי החודש העברי
#############################################

def get_mazal(hebrew_month: int) -> str:
    # hebrew_month 1 => ניסן => טלה; 2 => אייר => שור ... 12 => אדר => דגים
    index = (hebrew_month - 1) % 12
    # ייתכן שתרצה להתאים את הקישור (יש שיטות שונות)
    mazal_list = list(zodiac_data.keys())  # לפי הסדר שהגדרנו
    # אבל נלך לפי [טלה, שור, תאומים ...] כדי לשמור על סדר
    # נקבע רשימה מסודרת:
    ordered = [
        "טלה","שור","תאומים","סרטן","אריה","בתולה",
        "מאזניים","עקרב","קשת","גדי","דלי","דגים"
    ]
    return ordered[index]


#############################################
# פונקציה ראשית לבניית טקסט
#############################################

def build_report(name: str, mother: str, birthdate) -> str:
    # תאריך
    date_obj = datetime.strptime(str(birthdate), "%Y-%m-%d")
    hd = dates.HebrewDate.from_pydate(date_obj)

    # מזל
    mazal = get_mazal(hd.month)
    data = zodiac_data.get(mazal, {})

    # גימטריה
    g_name = gematria(name)
    g_mother = gematria(mother)
    g_sum = g_name + g_mother

    # בניית טקסט:
    text = f"""
**שלום {name} בן/בת {mother},**  
נולדת ביום {hd} ({birthdate.strftime('%d/%m/%Y')}). מזלך הוא **{mazal}**.

__רמז גימטרי__  
- שם פרטי: {name} → {g_name}  
- שם האם: {mother} → {g_mother}  
- סכום השמות: {g_sum}

__מבוא למזל {mazal}__  
{data.get('intro','')}

__פסוק מקראי:__  
{data.get('pasuk','')}

__מקטע הזוהר:__  
{data.get('zohar','')}

__רעיון מכתבי האר\"י:__  
{data.get('arizal','')}

__חיבור לתניא:__  
{data.get('tanya','')}

__סיכום קצר:__  
{data.get('summary','')}

"""
    return text


#############################################
# מבנה האפליקציה
#############################################

st.title("מפת הנשמה - גרסה מורחבת לכל המזלות")

st.markdown("מלא/י את הפרטים וקבל/י טעימה מעמיקה מהמזל שלך, גימטריה של השמות, והצצה למקורות:")

with st.form("neshama_form"):
    user_name = st.text_input("שם פרטי")
    mother_name = st.text_input("שם האם")
    date_input = st.date_input("תאריך לידה (לועזי)", min_value=datetime(1900,1,1), max_value=datetime.today())
    submitted = st.form_submit_button("קבל/י מפה מורחבת")

if submitted:
    if not user_name or not mother_name:
        st.error("אנא מלא/י גם שם פרטי וגם שם האם.")
    else:
        report = build_report(user_name, mother_name, date_input)
        st.markdown(report)

        st.markdown("---")
        st.markdown("#### רוצה מפה מלאה עוד יותר?")
        if st.button("לחץ/י כאן לרכישה"):
            st.success("זה המקום לשלב מנגנון תשלום אמיתי או להפנות לקישור חיצוני…")
